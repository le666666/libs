/**
 * Created by Hongcai Deng on 2015/12/28.
 */

'use strict';

const express = require('express');
const path = require('path');
const debug = require('debug')('app');
const bodyParser = require('body-parser');
const cookieParser = require('cookie-parser');
const shortid = require('shortid');
const cookie = require('cookie');
const config = require('./modules/config');

const api = require(path.join(__dirname, 'routes/api'));
const vercel = require(path.join(__dirname, 'routes/vercel'));
const app = express();

app.set('x-powered-by', false);
app.use(bodyParser.json());
app.use(cookieParser());

function setMetaToCookie(req, res) {
  if (!req.cookies.shortid) {
    const sid = shortid.generate().toLowerCase(); // generate shortid for a request
    const c = cookie.serialize('shortid', sid, {
      maxAge: 60 * 60 * 24 * 365
    });
    res.append('Set-Cookie', [c]);
  }
  const referer = req.hostname;
  let mailHosts = [];
  if (config.mailHostMap[referer]) {
    mailHosts = config.mailHostMap[referer];
  } else {
    mailHosts = config.mailHost;
  }
  const c = cookie.serialize('mailhosts', JSON.stringify(mailHosts), {
    maxAge: 60 * 60 * 24
  });
  res.append('Set-Cookie', [c]);
}

app.use(function (req, res, next) {
  setMetaToCookie(req, res);
  next();
});

app.use(express.static(path.join(__dirname, 'frontend/build/public'), { maxAge: 1 }));

app.use('/api', api);

app.use('/', vercel);

app.use(function(req, res, next) {
  let err = new Error('Not Found');
  err.status = 404;
  next(err);
});

app.use(err => debug(err));

module.exports = app;
